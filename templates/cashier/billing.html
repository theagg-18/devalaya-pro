{% extends "base.html" %}

{% block content %}
<div class="billing-container"
    style="display: grid; grid-template-columns: 1fr 350px; gap: 2rem; height: calc(100vh - 120px);">

    <!-- Left Panel: Item Selection -->
    <div class="card" style="display: flex; flex-direction: column; overflow: hidden; padding: 0;">
        <div style="padding: 1rem; border-bottom: 1px solid #e2e8f0; background: #f8fafc;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;">Select {{ 'Pujas' if mode == 'vazhipadu' else 'Items' }}</h3>
                <input type="text" id="searchBox" placeholder="Search..."
                    style="max-width: 200px; padding: 6px 12px; font-size: 0.9rem;" onkeyup="filterItems()">
            </div>
        </div>

        <div class="item-grid"
            style="padding: 1rem; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; align-content: start;">
            {% for item in items %}
            <button onclick="handleAddToCart(this)" class="item-btn" data-search="{{ item.name|lower }}"
                data-id="{{ item.id }}" data-name="{{ item.name }}" data-amount="{{ item.amount }}">
                <div class="item-name">{{ item.name }}</div>
                <div class="item-price">‚Çπ{{ "%.0f"|format(item.amount) }}</div>
            </button>
            {% endfor %}
        </div>
    </div>

    <!-- Right Panel: Cart & Details -->
    <div class="card"
        style="display: flex; flex-direction: column; padding: 0; border: 2px solid var(--primary); position: relative;">

        <!-- Batch Indicator -->
        {% if mode == 'vazhipadu' %}
        <div id="batchIndicator"
            style="background: #1e293b; color: white; padding: 8px 16px; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; gap: 8px; align-items: center;">
                {% set ns = namespace(total=0) %}
                {% for b in batch %}
                {% set ns.total = ns.total + b['total'] %}
                {% endfor %}
                <span>Batch: <strong id="batchCount">{{ batch|length }}</strong> bills <span
                        style="color: #94a3b8;">|</span> <strong>‚Çπ{{ "%.0f"|format(ns.total) }}</strong></span>
                {% if batch|length > 0 %}
                <button onclick="showBatchModal()" title="View/Edit Batch"
                    style="background: #3b82f6; border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                    üëÅÔ∏è
                </button>
                {% endif %}
            </div>

            {% if batch|length > 0 %}
            <button onclick="showPrintDialog()"
                style="background: #22c55e; border: none; color: white; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-weight: 600;">PRINT
                ALL</button>
            {% endif %}
        </div>
        {% endif %}

        <!-- Devotee Details Form -->
        <div style="padding: 1rem; background: #eff6ff; border-bottom: 1px solid #e2e8f0;">
            {% if mode == 'vazhipadu' %}
            <div class="form-group">
                <label style="font-size: 0.85rem;">Devotee Name</label>
                <input type="text" id="devName" value="{{ cart.devotee_name }}" onblur="updateDetails()"
                    placeholder="Name">
            </div>
            <div class="form-group" style="margin-bottom: 0;">
                <label style="font-size: 0.85rem;">Star</label>
                <select id="devStar" onchange="updateDetails()">
                    <option value="">Select Star</option>
                    {% for star in stars %}
                    <option value="{{ star }}" {% if cart.star==star %}selected{% endif %}>{{ star }}</option>
                    {% endfor %}
                </select>
            </div>
            {% else %}
            <h3 style="margin: 0; color: var(--primary);">Donation Mode</h3>
            <p style="font-size: 0.9rem; color: var(--text-muted);">Quick billing active</p>
            {% endif %}
        </div>

        <!-- Cart Items -->
        <div id="cartItems" style="flex: 1; overflow-y: auto; padding: 1rem;">
            <!-- Rendered via JS -->
            {% for item in cart['items'] %}
            <div class="cart-item">
                <div style="flex: 1;">
                    <div style="font-weight: 600;">{{ item.name }}</div>
                    <div style="font-size: 0.85rem; color: #64748b;">{{ item.count }} x ‚Çπ{{ item.amount }}</div>
                </div>
                <div style="text-align: right;">
                    <div style="font-weight: 600;">‚Çπ{{ "%.0f"|format(item.total) }}</div>
                    <button onclick="handleRemoveFromCart(this)" data-id="{{ item.id }}"
                        style="color: #ef4444; background: none; border: none; font-size: 0.8rem; cursor: pointer;">Remove</button>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Totals & Actions -->
        <div style="padding: 1.5rem; background: #f8fafc; border-top: 1px solid #e2e8f0;">
            <div
                style="display: flex; justify-content: space-between; margin-bottom: 1rem; font-size: 1.25rem; font-weight: 700;">
                <span>Total</span>
                <span id="cartTotal">‚Çπ{{ "%.0f"|format(cart.total|default(0)) }}</span>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 1rem;">
                <div style="display: flex; gap: 0.5rem;">
                    <button onclick="clearCart()" class="btn btn-secondary"
                        style="border-color: #ef4444; color: #ef4444; flex: 1;">Clear</button>
                    <button onclick="saveDraft()" class="btn btn-secondary" title="Save as Draft"
                        style="border-color: #f59e0b; color: #f59e0b; flex: 1;">Save Draft</button>
                </div>

                {% if mode == 'vazhipadu' %}
                <button onclick="addToBatch()" class="btn btn-primary">Add to Batch</button>
                {% else %}
                <button onclick="processDirectPrint()" class="btn btn-primary"
                    style="background: #22c55e; border-color: #22c55e;">Print Receipt</button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- View Batch Modal -->
<div id="batchModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; padding: 1rem;">
    <div class="card"
        style="width: 100%; max-width: 500px; max-height: 90vh; display: flex; flex-direction: column; padding: 0; margin: 0;">
        <div
            style="padding: 1rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 1.25rem;">Current Batch ({{ batch|length }})</h3>
            <button onclick="document.getElementById('batchModal').style.display='none'"
                style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">&times;</button>
        </div>

        <div style="padding: 1rem; overflow-y: auto; flex: 1;">
            {% for bill in batch %}
            <div
                style="padding: 0.75rem; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                <div style="min-width: 0;">
                    <div style="font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{
                        bill['devotee_name'] or 'No Name' }}</div>
                    <div style="font-size: 0.85rem; color: #64748b;">{{ bill['star'] }} ‚Ä¢ {{ bill['items']|length }}
                        items
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <div style="font-weight: 600;">‚Çπ{{ "%.0f"|format(bill.total) }}</div>
                    <button onclick="handleRecallBatchItem(this)" data-index="{{ loop.index0 }}" title="Edit"
                        style="color: #3b82f6; background: #eff6ff; border: none; padding: 6px; border-radius: 4px; cursor: pointer;">‚úèÔ∏è</button>
                    <button onclick="handleDeleteBatchItem(this)" data-index="{{ loop.index0 }}" title="Remove"
                        style="color: #ef4444; background: #fef2f2; border: none; padding: 6px; border-radius: 4px; cursor: pointer;">üóëÔ∏è</button>
                </div>
            </div>
            {% else %}
            <p class="text-center text-muted" style="padding: 2rem;">Batch is empty.</p>
            {% endfor %}
        </div>

        <div
            style="padding: 1rem; border-top: 1px solid #e2e8f0; text-align: right; background: #f8fafc; border-radius: 0 0 12px 12px;">
            <button onclick="document.getElementById('batchModal').style.display='none'"
                class="btn btn-secondary">Close</button>
        </div>
    </div>
</div>

<!-- Print Dialog Modal -->
<div id="printDialog"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; padding: 1rem; overflow-y: auto;">
    <div class="card"
        style="width: 100%; max-width: 400px; max-height: 90vh; overflow-y: auto; padding: 1.5rem; margin: auto;">
        <h3 class="mb-4" style="font-size: 1.25rem;">Print Options</h3>
        <p class="mb-4">Select grouping for this batch:</p>

        <div style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem;">
            <label
                style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
                <input type="radio" name="printGroup" value="puja" checked>
                <div style="min-width: 0;">
                    <strong>Group by Puja (Default)</strong>
                    <div class="text-muted" style="font-size: 0.8rem; white-space: normal;">Sorted by Item used for
                        Sanctum</div>
                </div>
            </label>

            <label
                style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
                <input type="radio" name="printGroup" value="devotee">
                <div style="min-width: 0;">
                    <strong>Group by Devotee</strong>
                    <div class="text-muted" style="font-size: 0.8rem; white-space: normal;">Sequential receipts per
                        person</div>
                </div>
            </label>
        </div>

        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="document.getElementById('printDialog').style.display='none'"
                class="btn btn-secondary">Cancel</button>
            <button onclick="processBatchPrint()" class="btn btn-primary">PRINT ALL</button>
        </div>
    </div>
</div>

<style>
    .item-btn {
        background: white;
        border: 1px solid #e2e8f0;
        padding: 1rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.1s;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100px;
    }

    .item-btn:hover {
        border-color: var(--primary);
        background: #eff6ff;
        transform: translateY(-2px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .item-btn:active {
        transform: translateY(0);
    }

    .item-name {
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 4px;
        color: var(--text-main);
    }

    .item-price {
        font-size: 0.9rem;
        color: var(--text-muted);
    }

    .cart-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px dashed #e2e8f0;
    }
</style>

{% endblock %}

{% block scripts %}
<script>
    const MODE = '{{ mode }}';

    function filterItems() {
        const query = document.getElementById('searchBox').value.toLowerCase();
        document.querySelectorAll('.item-btn').forEach(btn => {
            const name = btn.dataset.search;
            btn.style.display = name.includes(query) ? 'flex' : 'none';
        });
    }

    function handleAddToCart(btn) {
        addToCart(btn.dataset.id, btn.dataset.name, btn.dataset.amount);
    }

    function handleRemoveFromCart(btn) {
        removeFromCart(btn.dataset.id);
    }

    function handleRecallBatchItem(btn) {
        recallBatchItem(parseInt(btn.dataset.index));
    }

    function handleDeleteBatchItem(btn) {
        deleteBatchItem(parseInt(btn.dataset.index));
    }

    async function api(url, data) {
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        return await res.json();
    }

    async function addToCart(id, name, amount) {
        // Basic validation: if Vazhipadu mode, name must be filled before adding items? 
        // Usually better to let them add items first, but name is crucial for the "Entry".
        // Requirement "Enter name & star once" -> implies before Items.
        // I'll relax validation for adding to cart, but enforce for "Add to Batch".

        const res = await api('/cashier/billing/cart/update', {
            action: 'add', id, name, amount
        });
        renderCart(res.cart);
    }

    async function removeFromCart(id) {
        const res = await api('/cashier/billing/cart/update', {
            action: 'remove', id
        });
        renderCart(res.cart);
    }

    async function updateDetails() {
        if (MODE !== 'vazhipadu') return;
        const name = document.getElementById('devName').value;
        const star = document.getElementById('devStar').value;
        await api('/cashier/billing/cart/update', {
            action: 'set_details', name, star
        });
    }

    async function clearCart() {
        const res = await api('/cashier/billing/cart/update', {
            action: 'init', mode: MODE
        });
        renderCart(res.cart);
        if (MODE === 'vazhipadu') {
            document.getElementById('devName').value = '';
            document.getElementById('devStar').value = '';
        }
    }

    async function addToBatch() {
        // Validation
        const cart = document.getElementById('cartItems').children.length > 0; // rough check (or check model)
        // Actually we don't have cart object in JS scope fully updated, best to check server or simple DOM check
        // We can rely on server error.

        if (MODE === 'vazhipadu') {
            if (!document.getElementById('devName').value.trim()) {
                alert("Please enter Devotee Name");
                return;
            }
        }

        const btn = document.querySelector('button[onclick="addToBatch()"]');
        btn.disabled = true;

        const res = await api('/cashier/billing/batch/add', {});
        if (res.status === 'success') {
            // Update Batch Count
            document.getElementById('batchCount').innerText = res.batch_count;

            // Clear Form UI
            if (MODE === 'vazhipadu') {
                document.getElementById('devName').value = '';
                document.getElementById('devStar').value = '';
                document.getElementById('devName').focus(); // Ready for next devotee
            }

            // Cart is already cleared on server, re-render empty
            // We know its empty
            renderCart({ items: [], total: 0 });

            // Show Print Button in header if > 0
            location.reload(); // Quickest way to update the batch indicator buttons properly for now without complex DOM logic
        } else {
            alert(res.message);
        }
        btn.disabled = false;
    }



    function showPrintDialog() {
        if (MODE === 'donation') {
            processBatchPrint();
        } else {
            document.getElementById('printDialog').style.display = 'flex';
        }
    }

    function showBatchModal() {
        const modal = document.getElementById('batchModal');
        if (modal) modal.style.display = 'flex';
    }

    async function recallBatchItem(index) {
        // Confirm dialogs are blocked on some devices/kiosks, removing to ensure functionality
        // if (!confirm("Recall this bill to Edit?")) return;

        try {
            const res = await api('/cashier/billing/batch/recall', { index });
            if (res.status === 'success') {
                location.reload();
            } else {
                alert("Cannot Recall: " + res.message);
            }
        } catch (e) {
            console.error(e);
            alert("System Error during recall");
        }
    }

    async function deleteBatchItem(index) {
        // Confirm dialogs are blocked on some devices/kiosks, removing to ensure functionality
        // if (!confirm("Delete this bill from batch?")) return;

        try {
            const res = await api('/cashier/billing/batch/remove-entry', { index });
            if (res.status === 'success') {
                location.reload();
            } else {
                alert("Cannot Delete: " + res.message);
            }
        } catch (e) {
            console.error(e);
            alert("System Error during delete");
        }
    }

    async function processBatchPrint() {
        const type = document.querySelector('input[name="printGroup"]:checked').value;
        const btn = document.querySelector('button[onclick="processBatchPrint()"]');

        btn.innerText = 'Printing...';
        btn.disabled = true;

        try {
            const res = await api('/cashier/billing/checkout', {
                is_batch: true,
                group_by: type
            });

            if (res.status === 'success') {
                document.getElementById('printDialog').style.display = 'none';
                alert("Print Job Sent!");
                location.reload();
            } else if (res.status === 'print_web') {
                document.getElementById('printDialog').style.display = 'none';

                // Use Iframe to bypass popup blockers
                const iframe = document.createElement('iframe');
                iframe.style.position = 'fixed';
                iframe.style.right = '0';
                iframe.style.bottom = '0';
                iframe.style.width = '0';
                iframe.style.height = '0';
                iframe.style.border = '0';
                document.body.appendChild(iframe);

                const doc = iframe.contentWindow.document;
                doc.open();
                doc.write(res.content);
                doc.close();

                // Wait for content to load then print
                iframe.contentWindow.focus();
                setTimeout(() => {
                    iframe.contentWindow.print();

                    // Show confirmation overlay instead of auto-reloading
                    const overlay = document.createElement('div');
                    overlay.style.position = 'fixed';
                    overlay.style.top = '0';
                    overlay.style.left = '0';
                    overlay.style.width = '100%';
                    overlay.style.height = '100%';
                    overlay.style.background = 'rgba(0,0,0,0.8)';
                    overlay.style.zIndex = '2000'; // Above everything
                    overlay.style.display = 'flex';
                    overlay.style.flexDirection = 'column';
                    overlay.style.justifyContent = 'center';
                    overlay.style.alignItems = 'center';
                    overlay.style.color = 'white';
                    overlay.innerHTML = `
                        <h2 style="margin-bottom: 1rem; color: white;">Printing...</h2>
                        <p style="margin-bottom: 2rem; color: white;">Please finish printing in the system dialog.</p>
                        <button onclick="location.reload()" style="padding: 1rem 2rem; font-size: 1.2rem; background: #22c55e; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            Done / Start New Bill
                        </button>
                    `;
                    document.body.appendChild(overlay);
                }, 500);
            } else {
                alert("Error: " + res.message);
            }
        } catch (e) {
            console.error(e);
            alert("Network or Server Error");
        }

        btn.innerText = 'PRINT ALL';
        btn.disabled = false;
    }

    async function processDirectPrint() {
        const btn = document.querySelector('button[onclick="processDirectPrint()"]');
        btn.innerText = 'Printing...';
        btn.disabled = true;

        try {
            const res = await api('/cashier/billing/checkout', {
                is_batch: false
            });

            if (res.status === 'success') {
                alert("Print Job Sent!");
                location.reload();
            } else if (res.status === 'print_web') {
                // Use Iframe to bypass popup blockers
                const iframe = document.createElement('iframe');
                iframe.style.position = 'fixed';
                iframe.style.right = '0';
                iframe.style.bottom = '0';
                iframe.style.width = '0';
                iframe.style.height = '0';
                iframe.style.border = '0';
                document.body.appendChild(iframe);

                const doc = iframe.contentWindow.document;
                doc.open();
                doc.write(res.content);
                doc.close();

                // Wait for content to load then print
                iframe.contentWindow.focus();
                setTimeout(() => {
                    iframe.contentWindow.print();

                    // Show confirmation overlay instead of auto-reloading
                    const overlay = document.createElement('div');
                    overlay.style.position = 'fixed';
                    overlay.style.top = '0';
                    overlay.style.left = '0';
                    overlay.style.width = '100%';
                    overlay.style.height = '100%';
                    overlay.style.background = 'rgba(0,0,0,0.8)';
                    overlay.style.zIndex = '2000'; // Above everything
                    overlay.style.display = 'flex';
                    overlay.style.flexDirection = 'column';
                    overlay.style.justifyContent = 'center';
                    overlay.style.alignItems = 'center';
                    overlay.style.color = 'white';
                    overlay.innerHTML = `
                        <h2 style="margin-bottom: 1rem; color: white;">Printing...</h2>
                        <p style="margin-bottom: 2rem; color: white;">Please finish printing in the system dialog.</p>
                        <button onclick="location.reload()" style="padding: 1rem 2rem; font-size: 1.2rem; background: #22c55e; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            Done / Start New Bill
                        </button>
                    `;
                    document.body.appendChild(overlay);
                }, 500);
            } else {
                alert("Error: " + res.message);
                btn.innerText = 'Print Receipt';
                btn.disabled = false;
            }
        } catch (e) {
            console.error(e);
            alert("Network or Server Error");
            btn.innerText = 'Print Receipt';
            btn.disabled = false;
        }
    }

    async function saveDraft() {
        // Removed confirm to prevent blocking issues

        const btn = document.querySelector('button[title="Save as Draft"]');
        const originalText = btn.innerText;
        btn.innerText = 'Saving...';
        btn.disabled = true;

        try {
            const res = await api('/cashier/billing/draft/save', {});
            if (res.status === 'success') {
                alert(`Draft Saved! Ref No: ${res.bill_no}`);
                location.reload();
            } else {
                alert("Server Error: " + res.message);
            }
        } catch (e) {
            console.error(e);
            alert("Client Error: " + e.message);
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    function renderCart(cart) {
        const container = document.getElementById('cartItems');
        container.innerHTML = cart.items.map(item => `
        <div class="cart-item">
            <div style="flex: 1;">
                <div style="font-weight: 600;">${item.name}</div>
                <div style="font-size: 0.85rem; color: #64748b;">${item.count} x ‚Çπ${item.amount}</div>
            </div>
            <div style="text-align: right;">
                <div style="font-weight: 600;">‚Çπ${item.total}</div>
                <button onclick="handleRemoveFromCart(this)" data-id="${item.id}" style="color: #ef4444; background: none; border: none; font-size: 0.8rem; cursor: pointer;">Remove</button>
            </div>
        </div>
    `).join('');

        document.getElementById('cartTotal').innerText = '‚Çπ' + cart.total;

        if (cart.items.length === 0) {
            container.innerHTML = '<p class="text-center text-muted" style="margin-top:2rem;">Cart is empty</p>';
        }
    }
</script>
{% endblock %}