{% extends "base.html" %}

{% block content %}
<div class="billing-container"
    style="display: grid; grid-template-columns: 1fr 350px; gap: 2rem; height: calc(100vh - 120px);">

    <!-- Left Panel: Item Selection -->
    <div class="card" style="display: flex; flex-direction: column; overflow: hidden; padding: 0;">
        <div style="padding: 1rem; border-bottom: 1px solid #e2e8f0; background: #f8fafc;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0;">Select {{ 'Vazhipadu' if mode == 'vazhipadu' else 'Items' }} (‡¥§‡¥ø‡¥∞‡¥û‡µç‡¥û‡µÜ‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥ï)
                </h3>
                <input type="text" id="searchBox" placeholder="Search (‡¥§‡¥ø‡¥∞‡¥Ø‡µÅ‡¥ï)..."
                    style="max-width: 200px; padding: 6px 12px; font-size: 0.9rem;" onkeyup="filterItems()">
            </div>
        </div>

        <div class="item-grid"
            style="padding: 1rem; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; align-content: start;">
            {% for item in items %}
            <button onclick="handleAddToCart(this)" class="item-btn" data-search="{{ item.name|lower }}"
                data-id="{{ item.id }}" data-name="{{ item.name }}" data-amount="{{ item.amount }}">
                <div class="item-name">{{ item.name }}</div>
                <div class="item-price">‚Çπ{{ "%.0f"|format(item.amount) }}</div>
            </button>
            {% endfor %}
        </div>
    </div>

    <!-- Right Panel: Cart & Details -->
    <div class="card"
        style="display: flex; flex-direction: column; padding: 0; border: 2px solid var(--primary); position: relative;">

        <!-- Batch Indicator -->
        {% if mode == 'vazhipadu' %}
        <div id="batchIndicator"
            style="background: #1e293b; color: white; padding: 8px 16px; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; gap: 8px; align-items: center;">
                {% set ns = namespace(total=0) %}
                {% for b in batch %}
                {% set ns.total = ns.total + b['total'] %}
                {% endfor %}
                <span>Batch: <strong id="batchCount">{{ batch|length }}</strong> bills <span
                        style="color: #94a3b8;">|</span> <strong>‚Çπ{{ "%.0f"|format(ns.total) }}</strong></span>
                {% if batch|length > 0 %}
                <button onclick="showBatchModal()" title="View/Edit Batch"
                    style="background: #3b82f6; border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                    üëÅÔ∏è
                </button>
                {% endif %}
            </div>

            {% if batch|length > 0 %}
            <button onclick="showPrintDialog()"
                style="background: #22c55e; border: none; color: white; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-weight: 600;">PRINT
                ALL</button>
            {% endif %}
        </div>
        {% endif %}

        <!-- Browser Drafts Section (Rendered via JS) -->
        <div id="draftsSection"
            style="display: none; padding: 1rem; background: #fffbeb; border-bottom: 1px solid #fde68a;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <label
                    style="font-size: 0.75rem; color: #92400e; font-weight: 700; text-transform: uppercase; margin: 0;">Pending
                    Drafts</label>
                <button onclick="clearAllDrafts()"
                    style="background: none; border: none; color: #ef4444; font-size: 0.7rem; font-weight: 600; cursor: pointer;">Clear
                    All</button>
            </div>
            <div id="draftsList" style="display: flex; gap: 0.5rem; overflow-x: auto; padding-bottom: 0.25rem;">
                <!-- Rendered via JS -->
            </div>
        </div>

        <!-- Devotee Details Form -->
        <div style="padding: 1rem; background: #eff6ff; border-bottom: 1px solid #e2e8f0;">
            {% if mode == 'vazhipadu' %}
            <div class="form-group">
                <label style="font-size: 0.85rem;">‡¥≠‡¥ï‡µç‡¥§‡¥®‡µç‡¥±‡µÜ ‡¥™‡µá‡¥∞‡µç (Devotee Name)</label>
                <input type="text" id="devName" value="{{ cart.devotee_name }}" onblur="updateDetails()"
                    placeholder="‡¥™‡µá‡¥∞‡µç (NAME)">
            </div>
            <div class="form-group" style="margin-bottom: 0.75rem;">
                <label style="font-size: 0.85rem;">Star (‡¥®‡¥æ‡µæ)</label>
                <div class="autocomplete-container">
                    <input type="text" id="devStar" value="{{ cart.star }}" onblur="setTimeout(updateDetails, 200)"
                        onfocus="showStars()" oninput="filterStars()" placeholder="üîç Search Star (‡¥®‡¥æ‡µæ)..."
                        autocomplete="off">
                    <div id="starResults" class="autocomplete-results"></div>
                </div>
            </div>

            <div class="form-group" style="margin-bottom: 0;">
                <label style="font-size: 0.85rem;">Vazhipadu Date</label>
                <input type="date" id="scheduledDate" value="{{ cart.scheduled_date }}" onchange="updateDetails()">
            </div>
            {% else %}
            <h3 style="margin: 0; color: var(--primary);">Donation Mode</h3>
            <p style="font-size: 0.9rem; color: var(--text-muted);">Quick billing active</p>
            {% endif %}
        </div>

        <!-- Cart Items -->
        <div id="cartItems" style="flex: 1; overflow-y: auto; padding: 1rem;">
            <!-- Rendered via JS -->
            {% for item in cart['items'] %}
            <div class="cart-item">
                <div class="cart-item-info">
                    <div class="cart-item-title">{{ item.name }}</div>
                    <div class="cart-item-details">
                        <div class="qty-control">
                            <button onclick="changeQuantity('{{ item.id }}', '{{ item.count }}', -1)"
                                class="btn-qty minus" title="Decrease">
                                ‚àí
                            </button>
                            <span class="qty-display">{{ item.count }}</span>
                            <button onclick="changeQuantity('{{ item.id }}', '{{ item.count }}', 1)"
                                class="btn-qty plus" title="Increase">
                                +
                            </button>
                        </div>
                    </div>
                </div>
                <div class="cart-item-actions">
                    <div class="cart-item-price">‚Çπ{{ "%.0f"|format(item.total) }}</div>
                    <div style="font-size: 0.8rem; color: #94a3b8; margin-top: 2px;">(‚Çπ{{ "%.0f"|format(item.amount) }}
                        ea)</div>
                    <button onclick="handleRemoveFromCart(this)" data-id="{{ item.id }}" class="btn-remove"
                        title="Remove" style="margin-top: 4px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                            </path>
                        </svg>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Totals & Actions -->
        <div class="billing-totals-section"
            style="padding: 1.5rem; background: #f8fafc; border-top: 1px solid #e2e8f0;">
            <div
                style="display: flex; justify-content: space-between; margin-bottom: 1rem; font-size: 1.25rem; font-weight: 700;">
                <span>Total (‡¥Ü‡¥ï‡µÜ)</span>
                <span id="cartTotal">‚Çπ{{ "%.0f"|format(cart.total|default(0)) }}</span>
            </div>

            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                    <button onclick="clearCart()" class="btn btn-secondary"
                        style="border-color: #ef4444; color: #ef4444; flex: 1;">Clear</button>
                    <button onclick="saveDraft()" class="btn btn-secondary" title="Save as Draft"
                        style="border-color: #f59e0b; color: #f59e0b; flex: 1;">Save Draft</button>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                    {% if mode == 'vazhipadu' %}
                    <div style="display: flex; gap: 0.5rem;">
                        <button onclick="addToBatch()" class="btn btn-secondary"
                            style="border-color: var(--primary); color: var(--primary); flex: 1;">Add to Batch</button>
                        <button onclick="showReplicateModal()" class="btn btn-secondary"
                            title="Replicate to Multiple Dates"
                            style="border-color: #7e22ce; color: #7e22ce; flex: 0 0 auto;">üìÖ+</button>
                    </div>
                    <button onclick="processDirectPrint()" class="btn btn-primary"
                        style="background: #22c55e; border-color: #22c55e; flex: 1;">Print Receipt</button>
                    {% else %}
                    <button onclick="processDirectPrint()" class="btn btn-primary"
                        style="background: #22c55e; border-color: #22c55e; grid-column: span 2;">Print Receipt</button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Batch Modal -->
<div id="batchModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; padding: 1rem;">
    <div class="card"
        style="width: 100%; max-width: 500px; max-height: 90vh; display: flex; flex-direction: column; padding: 0; margin: 0;">
        <div
            style="padding: 1rem; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 1.25rem;">Current Batch ({{ batch|length }})</h3>
            <button onclick="document.getElementById('batchModal').style.display='none'"
                style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #64748b;">&times;</button>
        </div>

        <div style="padding: 1rem; overflow-y: auto; flex: 1;">
            {% for bill in batch %}
            <div
                style="padding: 0.75rem; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                <div style="min-width: 0;">
                    <div style="font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{
                        bill['devotee_name'] or 'No Name' }}</div>
                    <div style="font-size: 0.85rem; color: #64748b;">
                        {{ star_map.get(bill['star'], bill['star']) }} {% if bill['star'] in star_map %}({{ bill['star']
                        }}){% endif %} ‚Ä¢ {{ bill['items']|length }} items
                    </div>
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <div style="font-weight: 600;">‚Çπ{{ "%.0f"|format(bill.total) }}</div>
                    <button onclick="handleRecallBatchItem(this)" data-index="{{ loop.index0 }}" title="Edit"
                        style="color: #3b82f6; background: #eff6ff; border: none; padding: 6px; border-radius: 4px; cursor: pointer;">‚úèÔ∏è</button>
                    <button onclick="handleDeleteBatchItem(this)" data-index="{{ loop.index0 }}" title="Remove"
                        style="color: #ef4444; background: #fef2f2; border: none; padding: 6px; border-radius: 4px; cursor: pointer;">üóëÔ∏è</button>
                </div>
            </div>
            {% else %}
            <p class="text-center text-muted" style="padding: 2rem;">Batch is empty.</p>
            {% endfor %}
        </div>

        <div
            style="padding: 1rem; border-top: 1px solid #e2e8f0; text-align: right; background: #f8fafc; border-radius: 0 0 12px 12px;">
            <button onclick="document.getElementById('batchModal').style.display='none'"
                class="btn btn-secondary">Close</button>
        </div>
    </div>
</div>

<!-- Print Dialog Modal -->
<div id="printDialog"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; padding: 1rem; overflow-y: auto;">
    <div class="card"
        style="width: 100%; max-width: 400px; max-height: 90vh; overflow-y: auto; padding: 1.5rem; margin: auto;">
        <h3 class="mb-4" style="font-size: 1.25rem;">Print Options</h3>
        <p class="mb-4">Select grouping for this batch:</p>

        <div style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem;">
            <label
                style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
                <input type="radio" name="printGroup" value="puja" checked>
                <div style="min-width: 0;">
                    <strong>Group by Vazhipadu (Default)</strong>
                    <div class="text-muted" style="font-size: 0.8rem; white-space: normal;">Sorted by Item used for
                        Sanctum</div>
                </div>
            </label>

            <label
                style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer;">
                <input type="radio" name="printGroup" value="devotee">
                <div style="min-width: 0;">
                    <strong>Group by Devotee</strong>
                    <div class="text-muted" style="font-size: 0.8rem; white-space: normal;">Sequential receipts per
                        person</div>
                </div>
            </label>
        </div>

        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
            <button onclick="document.getElementById('printDialog').style.display='none'"
                class="btn btn-secondary">Cancel</button>
            <button onclick="processBatchPrint()" class="btn btn-primary">PRINT ALL</button>
        </div>
    </div>
</div>

<style>
    .item-btn {
        background: white;
        border: 1px solid #e2e8f0;
        padding: 1rem;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.1s;
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: 100px;
    }

    .item-btn:hover {
        border-color: var(--primary);
        background: #eff6ff;
        transform: translateY(-2px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .item-btn:active {
        transform: translateY(0);
    }

    .item-name {
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 4px;
        color: var(--text-main);
    }

    .item-price {
        font-size: 0.9rem;
        color: var(--text-muted);
    }

    .cart-item {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: box-shadow 0.2s;
    }

    .cart-item:hover {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        border-color: #cbd5e1;
    }

    .cart-item-info {
        flex: 1;
    }

    .cart-item-title {
        font-weight: 600;
        color: var(--text-main);
        font-size: 0.95rem;
    }

    .cart-item-details {
        font-size: 0.85rem;
        color: var(--text-muted);
        margin-top: 2px;
    }

    .cart-item-actions {
        text-align: right;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
    }

    .cart-item-price {
        font-weight: 700;
        color: var(--text-main);
    }

    .btn-remove {
        background: #fee2e2;
        color: #ef4444;
        border: none;
        width: 28px;
        height: 28px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s;
    }

    .btn-remove:hover {
        background: #fecaca;
    }

    /* Qty Controls */
    .qty-control {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 4px;
        background: #f1f5f9;
        padding: 2px;
        border-radius: 6px;
        width: fit-content;
    }

    .btn-qty {
        background: white;
        border: 1px solid #cbd5e1;
        width: 24px;
        height: 24px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        padding: 0;
        font-weight: 600;
        color: var(--text-main);
        transition: all 0.1s;
    }

    .btn-qty:hover {
        background: white;
        border-color: var(--primary);
        color: var(--primary);
    }

    .btn-qty.minus {
        color: #ef4444;
    }

    .btn-qty.plus {
        color: #22c55e;
    }

    .qty-display {
        font-weight: 600;
        font-size: 0.9rem;
        min-width: 20px;
        text-align: center;
        color: var(--text-main);
    }

    /* Mobile Sticky Footer */
    @media (max-width: 768px) {
        .billing-totals-section {
            position: sticky;
            bottom: 0;
            background: white;
            border-top: 2px solid #e2e8f0;
            z-index: 50;
            padding: 1rem !important;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    }
</style>

<!-- Replicate Modal -->
<div id="replicateModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; padding: 1rem;">
    <div class="card"
        style="width: 100%; max-width: 400px; padding: 1.5rem; margin: auto; display: flex; flex-direction: column; gap: 1rem;">
        <h3 style="margin: 0; font-size: 1.25rem;">Replicate to Dates</h3>
        <p style="margin: 0; color: #64748b; font-size: 0.9rem;">Select dates to create copies of this bill.</p>

        <div style="display: flex; gap: 0.5rem;">
            <input type="date" id="repDateInput"
                style="flex: 1; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 4px;">
            <button onclick="addRepDate()" class="btn btn-secondary">Add</button>
        </div>

        <div id="repDateList"
            style="display: flex; flex-wrap: wrap; gap: 0.5rem; max-height: 150px; overflow-y: auto; padding: 0.5rem; background: #f8fafc; border-radius: 4px; border: 1px solid #e2e8f0;">
            <!-- Chips go here -->
            <span class="text-muted" style="font-size: 0.8rem; padding: 1rem; width: 100%; text-align: center;">No dates
                selected</span>
        </div>

        <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 0.5rem;">
            <button onclick="closeReplicateModal()" class="btn btn-secondary">Cancel</button>
            <button onclick="processReplicate()" class="btn btn-primary"
                style="background: #7e22ce; border-color: #7e22ce;">Replicate & Add</button>
        </div>
    </div>
</div>

<style>
    .date-chip {
        background: white;
        border: 1px solid #cbd5e1;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .date-chip button {
        background: none;
        border: none;
        color: #ef4444;
        font-weight: bold;
        cursor: pointer;
        padding: 0;
        font-size: 14px;
        line-height: 1;
    }
</style>

{% endblock %}

{% block scripts %}
<script id="data-stars" type="application/json">{{ stars | tojson | safe }}</script>
<script id="data-cart" type="application/json">{{ cart | tojson | safe }}</script>

<script>
    const ALL_STARS = JSON.parse(document.getElementById('data-stars').textContent);
    const MODE = '{{ mode }}';
    let lastPrintContent = ""; // For Reprint Logic

    function printContentInIframe(content) {
        const iframe = document.createElement('iframe');
        iframe.style.position = 'fixed';
        iframe.style.right = '0';
        iframe.style.bottom = '0';
        iframe.style.width = '0';
        iframe.style.height = '0';
        iframe.style.border = '0';
        document.body.appendChild(iframe);

        const doc = iframe.contentWindow.document;
        doc.open();
        doc.write(content);
        doc.close();

        iframe.contentWindow.focus();
        setTimeout(() => {
            iframe.contentWindow.print();
            // Remove iframe after printing to save memory? 
            // Better keep it until page reload or remove it now.
            // document.body.removeChild(iframe); 
            // Removing it might break print dialog flow in some browsers if done too early.
        }, 500);
    }

    function reprintLast() {
        if (lastPrintContent) {
            printContentInIframe(lastPrintContent);
        } else {
            alert("Nothing to reprint.");
        }
    }

    function filterItems() {
        const query = document.getElementById('searchBox').value.toLowerCase();
        document.querySelectorAll('.item-btn').forEach(btn => {
            const name = btn.dataset.search;
            btn.style.display = name.includes(query) ? 'flex' : 'none';
        });
    }

    function handleAddToCart(btn) {
        addToCart(btn.dataset.id, btn.dataset.name, btn.dataset.amount);
    }

    function handleRemoveFromCart(btn) {
        removeFromCart(btn.dataset.id);
    }

    function handleRecallBatchItem(btn) {
        recallBatchItem(parseInt(btn.dataset.index));
    }

    function handleDeleteBatchItem(btn) {
        deleteBatchItem(parseInt(btn.dataset.index));
    }

    async function api(url, data) {
        const res = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        return await res.json();
    }

    async function addToCart(id, name, amount) {
        // Basic validation: if Vazhipadu mode, name must be filled before adding items? 
        // Usually better to let them add items first, but name is crucial for the "Entry".
        // Requirement "Enter name & star once" -> implies before Items.
        // I'll relax validation for adding to cart, but enforce for "Add to Batch".

        const res = await api('/cashier/billing/cart/update', {
            action: 'add', id, name, amount
        });
        renderCart(res.cart);
    }

    async function removeFromCart(id) {
        const res = await api('/cashier/billing/cart/update', {
            action: 'remove', id
        });
        renderCart(res.cart);
    }

    async function updateDetails() {
        if (MODE !== 'vazhipadu') return;
        const name = document.getElementById('devName').value;
        const star = document.getElementById('devStar').value;
        const scheduled_date = document.getElementById('scheduledDate').value;
        await api('/cashier/billing/cart/update', {
            action: 'set_details', name, star, scheduled_date
        });
    }

    async function clearCart() {
        const res = await api('/cashier/billing/cart/update', {
            action: 'init', mode: MODE
        });
        renderCart(res.cart);
        if (MODE === 'vazhipadu') {
            document.getElementById('devName').value = '';
            document.getElementById('devStar').value = '';
            document.getElementById('scheduledDate').value = new Date().toISOString().split('T')[0];
        }
    }

    async function addToBatch() {
        // Validation
        const cart = document.getElementById('cartItems').children.length > 0; // rough check (or check model)
        // Actually we don't have cart object in JS scope fully updated, best to check server or simple DOM check
        // We can rely on server error.

        if (MODE === 'vazhipadu') {
            if (!document.getElementById('devName').value.trim()) {
                alert("Please enter Devotee Name");
                return;
            }
        }

        const btn = document.querySelector('button[onclick="addToBatch()"]');
        btn.disabled = true;

        const res = await api('/cashier/billing/batch/add', {});
        if (res.status === 'success') {
            // Update Batch Count
            document.getElementById('batchCount').innerText = res.batch_count;

            // Clear Form UI
            if (MODE === 'vazhipadu') {
                document.getElementById('devName').value = '';
                document.getElementById('devStar').value = '';
                // Keep the date as is, usually user batches for same date? 
                // Or reset to today? Let's reset to today for safety.
                document.getElementById('scheduledDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('devName').focus(); // Ready for next devotee
            }

            // Cart is already cleared on server, re-render empty
            // We know its empty
            renderCart({ items: [], total: 0 });

            // Show Print Button in header if > 0
            location.reload(); // Quickest way to update the batch indicator buttons properly for now without complex DOM logic
        } else {
            alert(res.message);
        }
        btn.disabled = false;
    }



    function showPrintDialog() {
        if (MODE === 'donation') {
            processBatchPrint();
        } else {
            document.getElementById('printDialog').style.display = 'flex';
        }
    }

    function showBatchModal() {
        const modal = document.getElementById('batchModal');
        if (modal) modal.style.display = 'flex';
    }

    async function recallBatchItem(index) {
        // Confirm dialogs are blocked on some devices/kiosks, removing to ensure functionality
        // if (!confirm("Recall this bill to Edit?")) return;

        try {
            const res = await api('/cashier/billing/batch/recall', { index });
            if (res.status === 'success') {
                location.reload();
            } else {
                alert("Cannot Recall: " + res.message);
            }
        } catch (e) {
            console.error(e);
            alert("System Error during recall");
        }
    }

    async function deleteBatchItem(index) {
        // Confirm dialogs are blocked on some devices/kiosks, removing to ensure functionality
        // if (!confirm("Delete this bill from batch?")) return;

        try {
            const res = await api('/cashier/billing/batch/remove-entry', { index });
            if (res.status === 'success') {
                location.reload();
            } else {
                alert("Cannot Delete: " + res.message);
            }
        } catch (e) {
            console.error(e);
            alert("System Error during delete");
        }
    }

    async function processBatchPrint() {
        const type = document.querySelector('input[name="printGroup"]:checked').value;
        const btn = document.querySelector('button[onclick="processBatchPrint()"]');

        btn.innerText = 'Printing...';
        btn.disabled = true;

        try {
            const res = await api('/cashier/billing/checkout', {
                is_batch: true,
                group_by: type
            });

            if (res.status === 'success') {
                document.getElementById('printDialog').style.display = 'none';
                alert("Print Job Sent!");
                location.reload();
            } else if (res.status === 'print_web') {
                document.getElementById('printDialog').style.display = 'none';

                // Store content for reprint
                lastPrintContent = res.content;

                // Use Iframe to bypass popup blockers
                printContentInIframe(res.content);

                // Show confirmation overlay instead of auto-reloading
                const overlay = document.createElement('div');
                overlay.style.position = 'fixed';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.width = '100%';
                overlay.style.height = '100%';
                overlay.style.background = 'rgba(0,0,0,0.8)';
                overlay.style.zIndex = '2000'; // Above everything
                overlay.style.display = 'flex';
                overlay.style.flexDirection = 'column';
                overlay.style.justifyContent = 'center';
                overlay.style.alignItems = 'center';
                overlay.style.color = 'white';
                overlay.innerHTML = `
                    <h2 style="margin-bottom: 1rem; color: white;">Printing...</h2>
                    <p style="margin-bottom: 2rem; color: white;">Please finish printing in the system dialog.</p>
                    <div style="display: flex; gap: 1rem;">
                        <button onclick="reprintLast()" style="padding: 1rem 2rem; font-size: 1.2rem; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            Reprint
                        </button>
                        <button onclick="location.reload()" style="padding: 1rem 2rem; font-size: 1.2rem; background: #22c55e; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            Done / Start New Bill
                        </button>
                    </div>
                `;
                document.body.appendChild(overlay);
            } else {
                alert("Error: " + res.message);
            }
        } catch (e) {
            console.error(e);
            alert("Network or Server Error");
        }

        btn.innerText = 'PRINT ALL';
        btn.disabled = false;
    }

    async function processDirectPrint() {
        const btn = document.querySelector('button[onclick="processDirectPrint()"]');
        btn.innerText = 'Printing...';
        btn.disabled = true;

        try {
            const res = await api('/cashier/billing/checkout', {
                is_batch: false
            });

            if (res.status === 'success') {
                alert("Print Job Sent!");
                location.reload();
            } else if (res.status === 'print_web') {
                // Store content for reprint
                lastPrintContent = res.content;

                // Use Iframe to bypass popup blockers
                printContentInIframe(res.content);

                // Show confirmation overlay instead of auto-reloading
                const overlay = document.createElement('div');
                overlay.style.position = 'fixed';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.width = '100%';
                overlay.style.height = '100%';
                overlay.style.background = 'rgba(0,0,0,0.8)';
                overlay.style.zIndex = '2000'; // Above everything
                overlay.style.display = 'flex';
                overlay.style.flexDirection = 'column';
                overlay.style.justifyContent = 'center';
                overlay.style.alignItems = 'center';
                overlay.style.color = 'white';
                overlay.innerHTML = `
                    <h2 style="margin-bottom: 1rem; color: white;">Printing...</h2>
                    <p style="margin-bottom: 2rem; color: white;">Please finish printing in the system dialog.</p>
                    <div style="display: flex; gap: 1rem;">
                        <button onclick="reprintLast()" style="padding: 1rem 2rem; font-size: 1.2rem; background: #3b82f6; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            Reprint
                        </button>
                        <button onclick="location.reload()" style="padding: 1rem 2rem; font-size: 1.2rem; background: #22c55e; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            Done / Start New Bill
                        </button>
                    </div>
                `;
                document.body.appendChild(overlay);
            } else {
                alert("Error: " + res.message);
                btn.innerText = 'Print Receipt';
                btn.disabled = false;
            }
        } catch (e) {
            console.error(e);
            alert("Network or Server Error");
            btn.innerText = 'Print Receipt';
            btn.disabled = false;
        }
    }

    const DRAFTS_KEY = 'devalaya_billing_sessions';
    let CURRENT_CART = JSON.parse(document.getElementById('data-cart').textContent);

    function renderDrafts() {
        const drafts = JSON.parse(localStorage.getItem(DRAFTS_KEY) || '[]');
        const now = Date.now();
        const twelveHours = 12 * 60 * 60 * 1000;

        // Auto-delete drafts older than 12 hours
        const validDrafts = drafts.filter(d => (now - d.timestamp) < twelveHours);
        if (validDrafts.length !== drafts.length) {
            localStorage.setItem(DRAFTS_KEY, JSON.stringify(validDrafts));
        }

        const modeDrafts = validDrafts.filter(d => d.cart.mode === MODE);
        const section = document.getElementById('draftsSection');
        const list = document.getElementById('draftsList');

        if (modeDrafts.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';
        list.innerHTML = modeDrafts.map(d => {
            const name = d.cart.devotee_name || 'Quick Bill';
            const total = d.cart.total;
            const time = new Date(d.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            return `
                <div style="position: relative; min-width: 130px;">
                    <div onclick="resumeDraft('${d.id}')" title="Saved at ${time}"
                        style="display: flex; flex-direction: column; background: white; border: 1px solid #fde68a; padding: 6px 10px; border-radius: 6px; cursor: pointer; box-shadow: var(--shadow-sm); height: 100%;">
                        <span style="font-size: 0.8rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 15px;">
                            ${name}
                        </span>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2px;">
                            <span style="font-size: 0.7rem; color: #b45309;">‚Çπ${total}</span>
                            <span style="font-size: 0.6rem; color: #94a3b8;">${time}</span>
                        </div>
                    </div>
                    <button onclick="discardDraft(event, '${d.id}')" 
                        style="position: absolute; top: 2px; right: 2px; background: #fee2e2; color: #ef4444; border: none; border-radius: 4px; width: 22px; height: 22px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10;">
                        ‚úï
                    </button>
                </div>
            `;
        }).join('');
    }

    async function saveDraft() {
        if (!CURRENT_CART || !CURRENT_CART.items || CURRENT_CART.items.length === 0) {
            alert("Cart is empty");
            return;
        }

        const drafts = JSON.parse(localStorage.getItem(DRAFTS_KEY) || '[]');
        const newDraft = {
            id: 'dr_' + Date.now(),
            timestamp: Date.now(),
            cart: { ...CURRENT_CART, mode: MODE }
        };

        drafts.unshift(newDraft);
        localStorage.setItem(DRAFTS_KEY, JSON.stringify(drafts));

        // Clear server cart and reload
        await api('/cashier/billing/cart/update', { action: 'init', mode: MODE });
        location.reload();
    }

    async function resumeDraft(id) {
        const drafts = JSON.parse(localStorage.getItem(DRAFTS_KEY) || '[]');
        const draft = drafts.find(d => d.id === id);
        if (!draft) return;

        try {
            const res = await api('/cashier/billing/cart/resume-draft', { cart: draft.cart });
            if (res.status === 'success') {
                // Remove from drafts once resumed
                const remaining = drafts.filter(d => d.id !== id);
                localStorage.setItem(DRAFTS_KEY, JSON.stringify(remaining));
                window.location.reload();
            }
        } catch (e) {
            console.error("Resume error:", e);
            alert("Failed to resume session. Please try again.");
        }
    }

    function discardDraft(e, id) {
        if (e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Confirm dialogs are blocked on some devices/kiosks, removing to ensure functionality
        // if (!window.confirm("Discard this session?")) return;

        try {
            const drafts = JSON.parse(localStorage.getItem(DRAFTS_KEY) || '[]');
            const remaining = drafts.filter(d => String(d.id) !== String(id));
            localStorage.setItem(DRAFTS_KEY, JSON.stringify(remaining));

            // Re-render and also refresh the UI section
            renderDrafts();

            // If it was the last one, the section will hide via renderDrafts
        } catch (err) {
            console.error("Discard error:", err);
            // Fallback: clear and reload if anything fails
            window.location.reload();
        }
    }

    function clearAllDrafts() {
        // if (!confirm("Discard ALL pending sessions for this mode?")) return;
        const drafts = JSON.parse(localStorage.getItem(DRAFTS_KEY) || '[]');
        const remaining = drafts.filter(d => d.cart.mode !== MODE);
        localStorage.setItem(DRAFTS_KEY, JSON.stringify(remaining));
        renderDrafts();
    }

    async function changeQuantity(id, currentQty, delta) {
        const newQty = parseInt(currentQty) + parseInt(delta);
        if (newQty <= 0) {
            // Optional: Confirm before removal? 
            // For speed, cashier apps usually just remove.
            removeFromCart(id);
            return;
        }

        const res = await api('/cashier/billing/cart/update', {
            action: 'update_quantity', id: id, count: newQty
        });
        renderCart(res.cart);
    }

    function renderCart(cart) {
        CURRENT_CART = cart; // Keep client-side state in sync
        const container = document.getElementById('cartItems');
        container.innerHTML = cart.items.map(item => `
        <div class="cart-item">
            <div class="cart-item-info">
                <div class="cart-item-title">${item.name}</div>
                <div class="cart-item-details">
                    <div class="qty-control">
                        <button onclick="changeQuantity('${item.id}', ${item.count}, -1)" class="btn-qty minus" title="Decrease">
                            ‚àí
                        </button>
                        <span class="qty-display">${item.count}</span>
                        <button onclick="changeQuantity('${item.id}', ${item.count}, 1)" class="btn-qty plus" title="Increase">
                            +
                        </button>
                    </div>
                </div>
            </div>
            <div class="cart-item-actions">
                <div class="cart-item-price">‚Çπ${item.total}</div>
                <div style="font-size: 0.8rem; color: #94a3b8; margin-top: 2px;">(‚Çπ${item.amount} ea)</div>
                <!-- Optional: Keep Remove button or rely on Qty 0? Keeping it is safer for Quick Remove -->
                <button onclick="removeFromCart('${item.id}')" class="btn-remove" title="Remove" style="margin-top: 4px;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                </button>
            </div>
        </div>
    `).join('');

        document.getElementById('cartTotal').innerText = '‚Çπ' + cart.total;

        if (cart.items.length === 0) {
            container.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #94a3b8; opacity: 0.6;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
                    <p style="margin-top: 1rem; font-size: 0.9rem;">Cart is empty</p>
                </div>
            `;
        }
    }

    // Autocomplete Logic
    function showStars() {
        if (MODE !== 'vazhipadu') return;
        filterStars();
    }

    function filterStars() {
        const input = document.getElementById('devStar');
        const results = document.getElementById('starResults');
        const query = input.value.toLowerCase().trim();

        results.classList.add('active');

        const filtered = ALL_STARS.filter(s =>
            s.eng.toLowerCase().includes(query) ||
            s.mal.includes(query)
        );

        if (filtered.length === 0) {
            results.innerHTML = '<div class="autocomplete-item text-muted">No results found</div>';
            return;
        }

        results.innerHTML = filtered.map(s => `
            <div class="autocomplete-item" onclick="selectStar('${s.mal}')">
                <span>${s.mal}</span>
                <span class="eng-hint">${s.eng}</span>
            </div>
        `).join('');
    }

    function selectStar(val) {
        const input = document.getElementById('devStar');
        input.value = val;
        hideStars();
        updateDetails();
    }

    // --- Replicate Logic ---
    let REPLICATE_DATES = [];

    function showReplicateModal() {
        if (!document.getElementById('devName').value.trim()) {
            alert("Please enter Devotee Name first.");
            return;
        }
        document.getElementById('replicateModal').style.display = 'flex';
        REPLICATE_DATES = [];
        renderRepDates();
        // Set default date to picker
        document.getElementById('repDateInput').value = new Date().toISOString().split('T')[0];
    }

    function closeReplicateModal() {
        document.getElementById('replicateModal').style.display = 'none';
        REPLICATE_DATES = [];
    }

    function addRepDate() {
        const input = document.getElementById('repDateInput');
        const val = input.value;
        if (!val) return;

        if (!REPLICATE_DATES.includes(val)) {
            REPLICATE_DATES.push(val);
            REPLICATE_DATES.sort();
        }
        renderRepDates();
    }

    function removeRepDate(dateStr) {
        REPLICATE_DATES = REPLICATE_DATES.filter(d => d !== dateStr);
        renderRepDates();
    }

    function renderRepDates() {
        const container = document.getElementById('repDateList');
        if (REPLICATE_DATES.length === 0) {
            container.innerHTML = '<span class="text-muted" style="font-size: 0.8rem; padding: 1rem; width: 100%; text-align: center;">No dates selected</span>';
            return;
        }
        container.innerHTML = REPLICATE_DATES.map(d => `
            <div class="date-chip">
                <span>${formatDate(d)}</span>
                <button onclick="removeRepDate('${d}')">&times;</button>
            </div>
        `).join('');
    }

    function formatDate(isoStr) {
        const parts = isoStr.split('-');
        return `${parts[2]}-${parts[1]}-${parts[0]}`;
    }

    async function processReplicate() {
        if (REPLICATE_DATES.length === 0) {
            alert("Select at least one date.");
            return;
        }

        const btn = document.querySelector('button[onclick="processReplicate()"]');
        btn.disabled = true;
        btn.innerText = "Processing...";

        try {
            const res = await api('/cashier/billing/batch/add', {
                dates: REPLICATE_DATES
            });

            if (res.status === 'success') {
                document.getElementById('batchCount').innerText = res.batch_count;

                // Reset Form
                document.getElementById('devName').value = '';
                document.getElementById('devStar').value = '';
                document.getElementById('scheduledDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('devName').focus();

                renderCart({ items: [], total: 0 });
                closeReplicateModal();
                location.reload();
            } else {
                alert(res.message);
            }
        } catch (e) {
            console.error(e);
            alert("Error replicating bills.");
        }

        btn.disabled = false;
        btn.innerText = "Replicate & Add";
    }

    function hideStars() {
        setTimeout(() => {
            const results = document.getElementById('starResults');
            if (results) results.classList.remove('active');
        }, 300);
    }

    // Initialize
    renderDrafts();

    if (MODE === 'vazhipadu') {
        const dateInput = document.getElementById('scheduledDate');
        if (dateInput && !dateInput.value) {
            dateInput.value = new Date().toISOString().split('T')[0];
            updateDetails();
        }

        // Close results when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.autocomplete-container')) {
                const res = document.getElementById('starResults');
                if (res) res.classList.remove('active');
            }
        });
    }
</script>
{% endblock %}