{% extends "admin/layout.html" %}

{% block admin_content %}
<div class="card">
    <h2>Printer Management</h2>
    <p class="text-muted">Manage thermal printers connected to this system.</p>

    <!-- Registered Printers -->
    <h3 class="mt-4">Active Printers</h3>
    <table style="width: 100%; border-collapse: collapse; margin-bottom: 2rem;">
        <thead>
            <tr style="text-align: left; border-bottom: 2px solid #e2e8f0;">
                <th style="padding: 12px;">Friendly Name</th>
                <th style="padding: 12px;">System Name (CUPS)</th>
                <th style="padding: 12px;">Status</th>
                <th style="padding: 12px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for printer in registered_printers %}
            <tr style="border-bottom: 1px solid #e2e8f0;">
                <td style="padding: 12px;">{{ printer.friendly_name }}</td>
                <td style="padding: 12px; font-family: monospace;">{{ printer.name }}</td>
                <td style="padding: 12px;">
                    {% if printer.is_active %}
                    <span style="color: green;">● Active</span>
                    {% else %}
                    <span style="color: gray;">○ Disabled</span>
                    {% endif %}
                </td>
                <td style="padding: 12px; display: flex; gap: 8px;">
                    <form method="post" style="display:inline;">
                        <input type="hidden" name="printer_id" value="{{ printer.id }}">
                        <input type="hidden" name="is_active" value="{{ 0 if printer.is_active else 1 }}">
                        <button type="submit" name="toggle_active" class="btn btn-secondary"
                            style="padding: 4px 8px; font-size: 0.8rem;">
                            {{ "Disable" if printer.is_active else "Enable" }}
                        </button>
                    </form>
                    <form method="post" style="display:inline-block;">
                        <input type="hidden" name="printer_id" value="{{ printer.id }}">
                        <button type="submit" name="delete_printer" class="btn btn-secondary"
                            onclick="return confirmAction(event, 'Delete printer?')"
                            style="padding: 4px 8px; font-size: 0.8rem; color: #ef4444; border-color: #ef4444;">
                            Remove
                        </button>
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="4" style="padding: 12px; text-align: center;">No printers configured.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Available System Printers -->
    <h3>Discovered System Printers</h3>

    <!-- Manual Add -->
    <div class="card"
        style="padding: 1rem; border: 1px dashed #cbd5e1; box-shadow: none; margin-bottom: 2rem; background: #f8fafc;">
        <h4>Manually Add Printer</h4>
        <p class="text-muted" style="margin-bottom: 1rem; font-size: 0.9rem;">If auto-discovery fails, enter the CUPS
            printer name directly.</p>
        <form method="post" style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
            <div class="form-group" style="flex: 1; min-width: 200px;">
                <label>CUPS Name / Queue Name</label>
                <input type="text" name="cups_name" placeholder="e.g. POS-80" required>
            </div>
            <div class="form-group" style="flex: 1; min-width: 200px;">
                <label>Friendly Name</label>
                <input type="text" name="friendly_name" placeholder="e.g. Counter 1" required>
            </div>
            <div class="form-group">
                <button type="submit" name="add_printer" class="btn btn-primary" style="width: 100%;">Add
                    Manually</button>
            </div>
        </form>
        </form>
    </div>

    <!-- Web Printer Shortcut -->
    <div style="margin-bottom: 2rem;">
        <form method="post" style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <input type="hidden" name="add_web_printer" value="1">
            <button type="submit" class="btn btn-primary"
                style="background: #8b5cf6; border-color: #7c3aed; white-space: nowrap;">
                + Add Browser Printer (Virtual)
            </button>
            <span class="text-muted" style="font-size: 0.9rem;">
                Creates a virtual printer that sends receipts back to this browser.
            </span>
        </form>
    </div>

    {% if available_printers %}
    <div class="flex-grid">
        {% for sys_printer in available_printers %}
        <div class="card" style="padding: 1rem; border: 1px dashed #cbd5e1; box-shadow: none;">
            <h4>{{ sys_printer }}</h4>
            <form method="post" class="mt-4">
                <input type="hidden" name="cups_name" value="{{ sys_printer }}">
                <div class="form-group">
                    <label>Assign Friendly Name:</label>
                    <input type="text" name="friendly_name" placeholder="e.g. Counter 1" required>
                </div>
                <button type="submit" name="add_printer" class="btn btn-primary" style="width: 100%;">Add
                    Support</button>
            </form>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p style="padding: 1rem; background: #f1f5f9; border-radius: 8px;">No new printers found on the system.</p>
    {% endif %}

</div>
{% endblock %}